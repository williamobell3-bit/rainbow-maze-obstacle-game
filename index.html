<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåà Rainbow Maze - 250 Levels!</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,#0f0a1e,#1a1333);min-height:100vh;display:flex;justify-content:center;align-items:center;font-family:system-ui,-apple-system,sans-serif;overflow:auto}
    #root{display:flex;justify-content:center;align-items:center;flex-direction:column}
    @keyframes portalPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.12);opacity:.7}}
    @keyframes bubbleFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-4px) scale(1.05)}}
    @keyframes bubbleShield{0%{transform:scale(1);opacity:.9}100%{transform:scale(1.1);opacity:.5}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    @keyframes slideIn{0%{transform:scale(.8);opacity:0}100%{transform:scale(1);opacity:1}}
    @keyframes spikeGlow{0%,100%{opacity:.8}50%{opacity:1}}
  </style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
const{useState,useEffect,useCallback,useRef}=React;
const el=React.createElement;
const COLORS=['red','orange','yellow','green','blue','purple','pink'];
const COLOR_HEX={red:'#ef4444',orange:'#f97316',yellow:'#eab308',green:'#22c55e',blue:'#3b82f6',purple:'#a855f7',pink:'#ec4899'};
const GW=640,GH=480;
const LEVELS_PER_PAGE=25,TOTAL_LEVELS=250;
const CHARACTERS=[
  {id:'smiley',name:'Smiley',desc:'The classic!'},
  {id:'cat',name:'Cat',desc:'Meow!'},
  {id:'robot',name:'Robot',desc:'Beep boop!'},
  {id:'alien',name:'Alien',desc:'From beyond!'},
  {id:'ninja',name:'Ninja',desc:'Silent & deadly!'},
  {id:'panda',name:'Panda',desc:'Bamboo power!'}
];

// Dynamic maze dimensions based on level
function getMazeDims(levelNum){
  if(levelNum>=100){
    const cs=24;
    return{cs,cols:Math.floor(GW/cs),rows:Math.floor(GH/cs)};
  }
  return{cs:32,cols:Math.floor(GW/32),rows:Math.floor(GH/32)};
}

const createRandom=(seed)=>{let s=seed;return()=>{s=(s*1103515245+12345)&0x7fffffff;return s/0x7fffffff;};};

const renderCharSVG=(id,sz)=>{
  const v='0 0 18 18';
  const k={
    smiley:[el('circle',{key:'b',cx:9,cy:9,r:8,fill:'#fbbf24',stroke:'#f59e0b',strokeWidth:1.5}),el('circle',{key:'e1',cx:6,cy:7,r:1.8,fill:'#1e1e1e'}),el('circle',{key:'e2',cx:12,cy:7,r:1.8,fill:'#1e1e1e'}),el('path',{key:'m',d:'M5.5 12 Q9 15 12.5 12',stroke:'#1e1e1e',strokeWidth:1.5,fill:'none',strokeLinecap:'round'})],
    cat:[el('circle',{key:'b',cx:9,cy:10,r:7,fill:'#f97316',stroke:'#ea580c',strokeWidth:1}),el('polygon',{key:'e1',points:'3,5 5,0 7,5',fill:'#f97316',stroke:'#ea580c',strokeWidth:.5}),el('polygon',{key:'e2',points:'11,5 13,0 15,5',fill:'#f97316',stroke:'#ea580c',strokeWidth:.5}),el('circle',{key:'p1',cx:6,cy:9,r:1.5,fill:'#1e1e1e'}),el('circle',{key:'p2',cx:12,cy:9,r:1.5,fill:'#1e1e1e'}),el('ellipse',{key:'n',cx:9,cy:11.5,rx:1,ry:.7,fill:'#1e1e1e'}),el('line',{key:'w1',x1:1,y1:9.5,x2:5,y2:9,stroke:'#1e1e1e',strokeWidth:.5}),el('line',{key:'w2',x1:1,y1:11,x2:5,y2:10.5,stroke:'#1e1e1e',strokeWidth:.5}),el('line',{key:'w3',x1:17,y1:9.5,x2:13,y2:9,stroke:'#1e1e1e',strokeWidth:.5}),el('line',{key:'w4',x1:17,y1:11,x2:13,y2:10.5,stroke:'#1e1e1e',strokeWidth:.5})],
    robot:[el('rect',{key:'b',x:2,y:4,width:14,height:12,rx:2,fill:'#94a3b8',stroke:'#64748b',strokeWidth:1}),el('rect',{key:'e1',x:5,y:7,width:3,height:2.5,rx:.5,fill:'#3b82f6'}),el('rect',{key:'e2',x:10,y:7,width:3,height:2.5,rx:.5,fill:'#3b82f6'}),el('rect',{key:'m',x:6,y:12,width:6,height:1.5,rx:.5,fill:'#64748b'}),el('line',{key:'a',x1:9,y1:0,x2:9,y2:4,stroke:'#64748b',strokeWidth:1.5}),el('circle',{key:'l',cx:9,cy:0,r:1.5,fill:'#ef4444'})],
    alien:[el('ellipse',{key:'b',cx:9,cy:10,rx:7,ry:8,fill:'#22c55e',stroke:'#16a34a',strokeWidth:1}),el('ellipse',{key:'e1',cx:6,cy:8,rx:2.5,ry:3,fill:'#1e1e1e'}),el('ellipse',{key:'e2',cx:12,cy:8,rx:2.5,ry:3,fill:'#1e1e1e'}),el('ellipse',{key:'p1',cx:6,cy:8,rx:1,ry:1.5,fill:'#4ade80'}),el('ellipse',{key:'p2',cx:12,cy:8,rx:1,ry:1.5,fill:'#4ade80'}),el('ellipse',{key:'m',cx:9,cy:14,rx:1.5,ry:.7,fill:'#16a34a'})],
    ninja:[el('circle',{key:'b',cx:9,cy:9,r:8,fill:'#312e81',stroke:'#1e1b4b',strokeWidth:1}),el('rect',{key:'band',x:1,y:6,width:16,height:4,rx:1,fill:'#ef4444'}),el('rect',{key:'band2',x:1,y:7,width:16,height:2,fill:'#dc2626'}),el('ellipse',{key:'e1',cx:6,cy:8,rx:2,ry:1,fill:'white'}),el('ellipse',{key:'e2',cx:12,cy:8,rx:2,ry:1,fill:'white'}),el('circle',{key:'p1',cx:6.5,cy:8,r:.7,fill:'#1e1e1e'}),el('circle',{key:'p2',cx:12.5,cy:8,r:.7,fill:'#1e1e1e'})],
    panda:[el('circle',{key:'b',cx:9,cy:10,r:7.5,fill:'white',stroke:'#e5e7eb',strokeWidth:1}),el('circle',{key:'ear1',cx:4,cy:4,r:3,fill:'#1e1e1e'}),el('circle',{key:'ear2',cx:14,cy:4,r:3,fill:'#1e1e1e'}),el('ellipse',{key:'ep1',cx:6,cy:8.5,rx:2.5,ry:2,fill:'#1e1e1e'}),el('ellipse',{key:'ep2',cx:12,cy:8.5,rx:2.5,ry:2,fill:'#1e1e1e'}),el('circle',{key:'p1',cx:6,cy:8.5,r:1,fill:'white'}),el('circle',{key:'p2',cx:12,cy:8.5,r:1,fill:'white'}),el('ellipse',{key:'n',cx:9,cy:11.5,rx:1.5,ry:1,fill:'#1e1e1e'})]
  };
  return el('svg',{width:sz,height:sz,viewBox:v},k[id]||k.smiley);
};

const findPath=(maze,sx,sy,ex,ey)=>{
  const R=maze.length,C=maze[0].length;
  const vis=Array(R).fill(0).map(()=>Array(C).fill(0));
  const par=Array(R).fill(0).map(()=>Array(C).fill(null));
  const q=[[sx,sy]];vis[sy][sx]=1;
  while(q.length){
    const[x,y]=q.shift();
    if(x===ex&&y===ey){const p=[];let cx=ex,cy=ey;while(cx!==null){p.unshift({x:cx,y:cy});const pp=par[cy][cx];if(pp){cx=pp.x;cy=pp.y;}else break;}return p;}
    for(const[dx,dy] of[[0,1],[0,-1],[1,0],[-1,0]]){
      const nx=x+dx,ny=y+dy;
      if(nx>=0&&nx<C&&ny>=0&&ny<R&&!vis[ny][nx]&&maze[ny][nx]===0){vis[ny][nx]=1;par[ny][nx]={x,y};q.push([nx,ny]);}
    }
  }
  return null;
};

// Fixed start: always cell (2,2), returns exact pixel center
function findSafeStart(maze,prefCX,prefCY,cs){
  return{x:2*cs+Math.floor((cs-18)/2), y:2*cs+Math.floor((cs-18)/2)};
}

function generateMaze(cols,rows,random,openness){
  const maze=Array(rows).fill(0).map(()=>Array(cols).fill(1));
  const vis=Array(rows).fill(0).map(()=>Array(cols).fill(0));
  const carve=(x,y)=>{
    vis[y][x]=1;maze[y][x]=0;
    for(const[dx,dy] of[[0,-2],[0,2],[-2,0],[2,0]].sort(()=>random()-.5)){
      const nx=x+dx,ny=y+dy;
      if(nx>0&&nx<cols-1&&ny>0&&ny<rows-1&&!vis[ny][nx]){maze[y+dy/2][x+dx/2]=0;carve(nx,ny);}
    }
  };
  carve(1,1);
  const rooms=[];
  for(let r=0;r<Math.floor(4+random()*5);r++){
    const rx=2+Math.floor(random()*(cols-8)),ry=2+Math.floor(random()*(rows-8));
    const rw=3+Math.floor(random()*4),rh=3+Math.floor(random()*4);
    rooms.push({x:rx,y:ry,width:rw,height:rh});
    for(let y=ry;y<Math.min(ry+rh,rows-1);y++) for(let x=rx;x<Math.min(rx+rw,cols-1);x++) maze[y][x]=0;
  }
  for(let y=1;y<rows-1;y++) for(let x=1;x<cols-1;x++){
    if(maze[y][x]===1&&random()<openness){
      const n=[maze[y-1]?.[x]===0,maze[y+1]?.[x]===0,maze[y]?.[x-1]===0,maze[y]?.[x+1]===0].filter(Boolean).length;
      if(n>=2)maze[y][x]=0;
    }
  }
  // Force-clear start area (cell 2,2) - 7x7 block guarantees no walls near spawn
  for(let dy=-3;dy<=3;dy++) for(let dx=-3;dx<=3;dx++){
    const nx=2+dx,ny=2+dy;
    if(nx>=1&&nx<cols-1&&ny>=1&&ny<rows-1) maze[ny][nx]=0;
  }
  // Force-clear end area
  for(let dy=-3;dy<=3;dy++) for(let dx=-3;dx<=3;dx++){
    const nx=(cols-2)+dx,ny=(rows-2)+dy;
    if(nx>=1&&nx<cols-1&&ny>=1&&ny<rows-1) maze[ny][nx]=0;
  }
  return{maze,rooms};
}

function generateLevel(levelNum){
  const random=createRandom(levelNum*54321);
  const{cs,cols,rows}=getMazeDims(levelNum);
  const diff=Math.min(levelNum/40,6),openness=Math.min(.12+diff*.025,.35);
  const{maze,rooms}=generateMaze(cols,rows,random,openness);
  const startCX=2,startCY=2;
  const endCX=cols-2,endCY=rows-2;

  // Get safe start (always cell 2,2 - area already cleared by generateMaze)
  const playerStart=findSafeStart(maze,startCX,startCY,cs);

  // Validate: convert pixel back to cell and double-check
  const psCX=Math.floor((playerStart.x+9)/cs), psCY=Math.floor((playerStart.y+9)/cs);

  const mainPath=findPath(maze,startCX,startCY,endCX,endCY);
  const pc=new Set();
  if(mainPath) mainPath.forEach(p=>{for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) pc.add(`${p.x+dx},${p.y+dy}`);});

  const numF=Math.min(1+Math.floor(levelNum/25),5);
  const forbiddenColors=[...COLORS].sort(()=>random()-.5).slice(0,numF);
  const monsters=[],gears=[],elevators=[],portals=[],swings=[],poison=[],bubbles=[],spikes=[];

  // Poison blocks
  for(let i=0;i<Math.floor(10+diff*8);i++){
    const col=forbiddenColors[Math.floor(random()*forbiddenColors.length)];
    for(let a=0;a<80;a++){
      const cx=3+Math.floor(random()*(cols-6)),cy=2+Math.floor(random()*(rows-4));
      if(maze[cy][cx]===0&&Math.hypot(cx-psCX,cy-psCY)>3&&Math.hypot(cx-endCX,cy-endCY)>3&&!pc.has(`${cx},${cy}`)){
        poison.push({x:cx*cs+4,y:cy*cs+4,width:cs-8,height:cs-8,color:col});break;
      }
    }
  }

  // Spikes
  const spikeProb=Math.min(.04+diff*.02,.15);
  const dirs=[{dx:0,dy:-1,dir:'up'},{dx:0,dy:1,dir:'down'},{dx:-1,dy:0,dir:'left'},{dx:1,dy:0,dir:'right'}];
  for(let y=1;y<rows-1;y++) for(let x=1;x<cols-1;x++){
    if(maze[y][x]!==1) continue;
    for(const{dx,dy,dir} of dirs){
      const nx=x+dx,ny=y+dy;
      if(nx>=0&&nx<cols&&ny>=0&&ny<rows&&maze[ny]?.[nx]===0){
        if(random()<spikeProb&&Math.hypot(nx-psCX,ny-psCY)>3&&Math.hypot(nx-endCX,ny-endCY)>2){
          let sx,sy,sw,sh;
          const spSz=Math.floor(cs*.2);
          if(dir==='right'){sx=x*cs+cs;sy=y*cs+Math.floor(cs*.25);sw=spSz;sh=Math.floor(cs*.5);}
          else if(dir==='left'){sx=x*cs-spSz;sy=y*cs+Math.floor(cs*.25);sw=spSz;sh=Math.floor(cs*.5);}
          else if(dir==='down'){sx=x*cs+Math.floor(cs*.25);sy=y*cs+cs;sw=Math.floor(cs*.5);sh=spSz;}
          else{sx=x*cs+Math.floor(cs*.25);sy=y*cs-spSz;sw=Math.floor(cs*.5);sh=spSz;}
          spikes.push({x:sx,y:sy,width:sw,height:sh,dir});
        }
      }
    }
  }

  // Monsters
  const usedR=new Set();
  for(let i=0;i<Math.floor(2+diff*2)&&rooms.length>0;i++){
    const ri=Math.floor(random()*rooms.length),room=rooms[ri];
    if(!usedR.has(ri)||random()>.5){
      usedR.add(ri);
      const vert=random()>.5,range=((vert?room.height:room.width)-2)*cs;
      if(range>40){
        let sx=(room.x+1)*cs+(room.width-2)*cs*random(),sy=(room.y+1)*cs+(room.height-2)*cs*random();
        if(Math.hypot(sx-playerStart.x,sy-playerStart.y)<cs*3)continue;
        let ar=range/2-20;
        if(mainPath&&mainPath.some(p=>p.x>=room.x&&p.x<room.x+room.width&&p.y>=room.y&&p.y<room.y+room.height))ar=Math.min(ar,range/4);
        if(ar>20)monsters.push({x:sx,y:sy,speed:1.2+diff*.35,direction:random()>.5?1:-1,vertical:vert,range:ar,startX:sx,startY:sy,color:['#8b5cf6','#06b6d4','#f43f5e','#10b981'][Math.floor(random()*4)]});
      }
    }
  }

  // Gears
  for(let i=0;i<Math.floor(1+diff*1.2)&&rooms.length>0;i++){
    const room=rooms[Math.floor(random()*rooms.length)];
    let gx=(room.x+room.width/2)*cs,gy=(room.y+room.height/2)*cs;
    if(Math.hypot(gx-playerStart.x,gy-playerStart.y)<cs*3)continue;
    const ccx=Math.floor(room.x+room.width/2),ccy=Math.floor(room.y+room.height/2);
    if(pc.has(`${ccx},${ccy}`)){gx=(room.x+1)*cs;gy=(room.y+1)*cs;}
    gears.push({x:gx,y:gy,radius:Math.floor(cs*.6+random()*cs*.4),rotation:0,speed:.025+diff*.008});
  }

  // Elevators
  for(let i=0;i<Math.floor(1+diff*.7);i++){
    for(let a=0;a<50;a++){
      const cx=3+Math.floor(random()*(cols-6)),cy=3+Math.floor(random()*(rows-6));
      if(Math.hypot(cx-psCX,cy-psCY)<3||pc.has(`${cx},${cy}`))continue;
      let hL=0,vL=0;
      for(let d=-5;d<=5;d++){if(maze[cy]?.[cx+d]===0)hL++;if(maze[cy+d]?.[cx]===0)vL++;}
      if(hL>=5||vL>=5){
        const vert=vL>hL,range=(vert?vL:hL)*cs/2-30;
        if(range>30){
          elevators.push({x:cx*cs+2,y:cy*cs+Math.floor(cs*.3),width:cs-4,height:Math.floor(cs*.4),vertical:vert,speed:1.2+diff*.25,range,offset:0,direction:1,color:COLORS[Math.floor(random()*COLORS.length)]});
          break;
        }
      }
    }
  }

  // Portals
  for(let i=0;i<Math.floor(diff*.5);i++){
    const col=`hsl(${random()*360},80%,60%)`;let pl=0;const pp=[];
    for(let a=0;a<50&&pl<2;a++){
      const cx=2+Math.floor(random()*(cols-4)),cy=2+Math.floor(random()*(rows-4));
      if(maze[cy][cx]===0){const px=cx*cs+cs/2,py=cy*cs+cs/2;if(pl===0||Math.hypot(px-pp[0].x,py-pp[0].y)>200){pp.push({x:px,y:py,color:col,pairIndex:-1});pl++;}}
    }
    if(pl===2){pp[0].pairIndex=portals.length+1;pp[1].pairIndex=portals.length;portals.push(...pp);}
  }

  // Swings
  for(let i=0;i<Math.floor(2+diff*1.2)&&rooms.length>0;i++){
    const room=rooms[Math.floor(random()*rooms.length)];
    if(room.height>=4&&room.width>=3){
      const sx=(room.x+room.width/2)*cs,sy=room.y*cs+5;
      if(Math.hypot(sx-playerStart.x,sy-playerStart.y)<cs*3)continue;
      const rHP=mainPath&&mainPath.some(p=>p.x>=room.x&&p.x<room.x+room.width&&p.y>=room.y&&p.y<room.y+room.height);
      swings.push({id:i,pivotX:sx,pivotY:sy,length:(room.height-1)*cs*(rHP?.6:.8),angle:Math.PI/2,speed:.018+diff*.004,direction:random()>.5?1:-1,type:['ball','blade','star'][Math.floor(random()*3)]});
    }
  }

  // Safety bubbles
  if(levelNum>=15){
    for(let i=0;i<Math.floor(1+(levelNum-15)/25);i++){
      for(let a=0;a<60;a++){
        const cx=3+Math.floor(random()*(cols-6)),cy=3+Math.floor(random()*(rows-6));
        if(maze[cy][cx]===0&&Math.hypot(cx-psCX,cy-psCY)>5&&Math.hypot(cx-endCX,cy-endCY)>4){
          const bx=cx*cs+cs/2,by=cy*cs+cs/2;
          if(!poison.some(p=>Math.hypot(bx-(p.x+p.width/2),by-(p.y+p.height/2))<30)){
            bubbles.push({id:i,x:bx,y:by,collected:false,duration:90+Math.floor(random()*150)});break;
          }
        }
      }
    }
  }

  return{levelNum,maze,rooms,forbiddenColors,poison,monsters,gears,elevators,portals,swings,bubbles,spikes,mainPath,cs,cols,rows,
    rainbow:{x:endCX*cs-Math.floor(cs*.5),y:endCY*cs-Math.floor(cs*1.1),width:Math.floor(cs*1.6),height:Math.floor(cs*1.7)},
    playerStart};
}

const Game=()=>{
  const[gs,setGs]=useState('menu');
  const[lvl,setLvl]=useState(1);
  const[ld,setLd]=useState(null);
  const[pl,setPl]=useState({x:40,y:40,size:18});
  const[lives,setLives]=useState(3);
  const[keys,setKeys]=useState({});
  const[inv,setInv]=useState(0);
  const[pcd,setPcd]=useState(0);
  const[ba,setBa]=useState(0);
  const[rs,setRs]=useState(null);
  const[sp,setSp]=useState(false);
  const[unlocked,setUnlocked]=useState(1);
  const[charId,setCharId]=useState('smiley');
  const[lobbyPage,setLobbyPage]=useState(0);
  const[isMobile,setIsMobile]=useState(false);
  const touchRef=useRef(null);
  const animRef=useRef(null);
  const ltRef=useRef(0);

  // Detect touch device
  useEffect(()=>{
    const check=()=>setIsMobile('ontouchstart' in window||navigator.maxTouchPoints>0||window.innerWidth<800);
    check();window.addEventListener('resize',check);return()=>window.removeEventListener('resize',check);
  },[]);

  // Touch control helpers - simulate key press/release
  const touchDown=useCallback((key)=>{
    setKeys(p=>({...p,[key]:true}));
    if(key===' '){setSp(true);if(gs==='intro')setGs('playing');}
  },[gs]);
  const touchUp=useCallback((key)=>{
    setKeys(p=>({...p,[key]:false}));
    if(key===' ')setSp(false);
  },[]);

  const renderDpad=()=>{
    const bs={width:52,height:52,borderRadius:10,border:'none',fontSize:22,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',userSelect:'none',WebkitUserSelect:'none',touchAction:'none'};
    const normal='rgba(255,255,255,.12)';
    const mkBtn=(label,key,gCol,gRow,extra)=>el('button',{
      key:key,
      onPointerDown:(ev)=>{ev.preventDefault();touchDown(key);},
      onPointerUp:(ev)=>{ev.preventDefault();touchUp(key);},
      onPointerLeave:(ev)=>{ev.preventDefault();touchUp(key);},
      onContextMenu:(ev)=>ev.preventDefault(),
      style:{...bs,background:normal,color:'white',gridColumn:gCol,gridRow:gRow,...(extra||{})}
    },label);
    return el('div',{style:{display:'grid',gridTemplateColumns:'52px 52px 52px',gridTemplateRows:'52px 52px 52px',gap:4}},
      mkBtn('‚ñ≤','arrowup',2,1),
      mkBtn('‚óÄ','arrowleft',1,2),
      mkBtn('‚ñº','arrowdown',2,3),
      mkBtn('‚ñ∂','arrowright',3,2)
    );
  };

  const renderTouchControls=()=>{
    return el('div',{style:{
      width:GW,maxWidth:'100vw',display:'flex',justifyContent:'space-between',alignItems:'center',
      padding:'12px 24px',background:'rgba(15,10,30,.95)',borderRadius:'0 0 12px 12px',
      borderTop:'1px solid rgba(255,255,255,.1)'
    }},
      renderDpad(),
      el('button',{
        onPointerDown:(ev)=>{ev.preventDefault();touchDown(' ');},
        onPointerUp:(ev)=>{ev.preventDefault();touchUp(' ');},
        onPointerLeave:(ev)=>{ev.preventDefault();touchUp(' ');},
        onContextMenu:(ev)=>ev.preventDefault(),
        style:{
          width:80,height:80,borderRadius:'50%',border:'3px solid rgba(34,197,94,.5)',
          background:'rgba(34,197,94,.15)',color:'#22c55e',fontSize:12,fontWeight:'bold',
          cursor:'pointer',userSelect:'none',WebkitUserSelect:'none',touchAction:'none',
          display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column',gap:2,
          boxShadow:'0 0 15px rgba(34,197,94,.2)'
        }
      },el('span',{style:{fontSize:18}},'üéØ'),el('span',{style:{fontSize:9}},'SPACE'))
    );
  };

  const startLevel=useCallback((l)=>{
    const data=generateLevel(l);
    // Always same position: cell (2,2) center - guaranteed clear by generateMaze
    const px=data.playerStart.x, py=data.playerStart.y;
    // Reset timing so game loop doesn't run stale frames
    ltRef.current=0;
    if(animRef.current){cancelAnimationFrame(animRef.current);animRef.current=null;}
    setLd(data);setPl({x:px,y:py,size:18});
    setKeys({});setInv(60);setPcd(0);setBa(0);setRs(null);setSp(false);setGs('intro');
  },[]);

  const startGame=(l)=>{setLvl(l);setLives(3);startLevel(l);};

  // CRITICAL: When entering 'playing' state, force-sync player to the level start position.
  // This eliminates any race conditions from state batching between levels.
  const playingLevelRef=useRef(null);
  useEffect(()=>{
    if(gs==='playing'&&ld){
      // Only reset position when entering playing for a NEW level (not every render)
      if(playingLevelRef.current!==ld.levelNum){
        playingLevelRef.current=ld.levelNum;
        const px=ld.playerStart.x,py=ld.playerStart.y;
        setPl({x:px,y:py,size:18});
        setKeys({});
        ltRef.current=0;
      }
    }
  },[gs,ld]);

  useEffect(()=>{
    const kd=(ev)=>{
      if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D',' '].includes(ev.key)){
        ev.preventDefault();
        // Don't register movement keys during intro->playing transition
        if(gs==='intro'&&ev.key===' '){setKeys({});ltRef.current=0;setGs('playing');return;}
        setKeys(p=>({...p,[ev.key.toLowerCase()]:true}));if(ev.key===' ')setSp(true);
      }
    };
    const ku=(ev)=>{setKeys(p=>({...p,[ev.key.toLowerCase()]:false}));if(ev.key===' ')setSp(false);};
    window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
    return()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku);};
  },[gs]);

  const wallCheck=useCallback((x,y,sz,maze,cs,cols,rows,phase)=>{
    if(phase)return x<0||x+sz>GW||y<0||y+sz>GH;
    const m=2,corners=[[x+m,y+m],[x+sz-m,y+m],[x+m,y+sz-m],[x+sz-m,y+sz-m]];
    for(const[cx,cy] of corners){
      const gx=Math.floor(cx/cs),gy=Math.floor(cy/cs);
      if(gx<0||gx>=cols||gy<0||gy>=rows||maze[gy]?.[gx]===1)return true;
    }
    return false;
  },[]);

  // Swing
  useEffect(()=>{
    if(gs!=='playing'||!ld||!sp)return;
    if(rs!==null){
      const sw=ld.swings[rs];
      if(sw){
        const ex=sw.pivotX+Math.sin(sw.angle)*sw.length,ey=sw.pivotY+Math.cos(sw.angle)*sw.length;
        if(!wallCheck(ex-pl.size/2,ey-pl.size/2,pl.size,ld.maze,ld.cs,ld.cols,ld.rows,false))
          setPl(p=>({...p,x:ex-p.size/2,y:ey-p.size/2}));
        else return;
      }
      setRs(null);setSp(false);return;
    }
    const pcx=pl.x+pl.size/2,pcy=pl.y+pl.size/2;
    for(let i=0;i<ld.swings.length;i++){
      const sw=ld.swings[i];const ex=sw.pivotX+Math.sin(sw.angle)*sw.length,ey=sw.pivotY+Math.cos(sw.angle)*sw.length;
      if(Math.hypot(pcx-ex,pcy-ey)<30){setRs(i);setSp(false);break;}
    }
    setSp(false);
  },[sp,gs,ld,rs,pl,wallCheck]);

  // Level complete
  useEffect(()=>{
    if(gs!=='levelComplete')return;
    const t=setTimeout(()=>{
      if(lvl>=TOTAL_LEVELS)setGs('win');
      else{const nl=lvl+1;setLvl(nl);startLevel(nl);}
    },1500);
    return()=>clearTimeout(t);
  },[gs,lvl,startLevel]);

  // Game loop
  useEffect(()=>{
    if(gs!=='playing'||!ld)return;
    const safeX=ld.playerStart.x,safeY=ld.playerStart.y;
    const loop=(ts)=>{
      if(!ltRef.current)ltRef.current=ts;
      if(ts-ltRef.current>16){
        ltRef.current=ts;
        if(rs===null){
          setPl(p=>{
            // RESCUE: if player is currently inside a wall, snap to start position
            if(wallCheck(p.x,p.y,p.size,ld.maze,ld.cs,ld.cols,ld.rows,false)){
              return{...p,x:safeX,y:safeY};
            }
            let nx=p.x,ny=p.y;const sp=3;
            if(keys.arrowleft||keys.a)nx-=sp;if(keys.arrowright||keys.d)nx+=sp;
            if(keys.arrowup||keys.w)ny-=sp;if(keys.arrowdown||keys.s)ny+=sp;
            if(wallCheck(nx,p.y,p.size,ld.maze,ld.cs,ld.cols,ld.rows,false))nx=p.x;
            if(wallCheck(nx,ny,p.size,ld.maze,ld.cs,ld.cols,ld.rows,false))ny=p.y;
            return{...p,x:Math.max(0,Math.min(GW-p.size,nx)),y:Math.max(0,Math.min(GH-p.size,ny))};
          });
        }
        setLd(p=>{
          const u={...p};
          u.monsters=p.monsters.map(m=>{let n={...m};if(m.vertical){n.y+=m.speed*m.direction;if(Math.abs(n.y-m.startY)>m.range)n.direction*=-1;}else{n.x+=m.speed*m.direction;if(Math.abs(n.x-m.startX)>m.range)n.direction*=-1;}return n;});
          u.gears=p.gears.map(g=>({...g,rotation:g.rotation+g.speed}));
          u.elevators=p.elevators.map(e=>{let n={...e};n.offset+=e.speed*e.direction;if(Math.abs(n.offset)>e.range)n.direction*=-1;return n;});
          u.swings=p.swings.map(s=>{let n={...s};n.angle+=s.speed*s.direction;if(n.angle>Math.PI*.9||n.angle<Math.PI*.1)n.direction*=-1;return n;});
          return u;
        });
        if(rs!==null&&ld.swings[rs]){
          const sw=ld.swings[rs];const ex=sw.pivotX+Math.sin(sw.angle)*sw.length,ey=sw.pivotY+Math.cos(sw.angle)*sw.length;
          setPl(p=>({...p,x:ex-p.size/2,y:ey-p.size/2}));
        }
        setInv(p=>Math.max(0,p-1));setPcd(p=>Math.max(0,p-1));setBa(p=>Math.max(0,p-1));
      }
      animRef.current=requestAnimationFrame(loop);
    };
    animRef.current=requestAnimationFrame(loop);
    return()=>{if(animRef.current)cancelAnimationFrame(animRef.current);};
  },[gs,ld,keys,wallCheck,rs]);

  // Collision
  useEffect(()=>{
    if(gs!=='playing'||!ld)return;
    const pr={x:pl.x,y:pl.y,width:pl.size,height:pl.size};
    const rr=(a,b)=>a.x<b.x+b.width&&a.x+a.width>b.x&&a.y<b.y+b.height&&a.y+a.height>b.y;
    const cr=(r,cx,cy,rad)=>{const dx=cx-Math.max(r.x,Math.min(cx,r.x+r.width)),dy=cy-Math.max(r.y,Math.min(cy,r.y+r.height));return dx*dx+dy*dy<rad*rad;};

    if(rr(pr,ld.rainbow)){setUnlocked(p=>Math.max(p,lvl+1));setGs('levelComplete');return;}

    for(const b of ld.bubbles.filter(b=>!b.collected)){
      if(cr(pr,b.x,b.y,14)){setLd(p=>({...p,bubbles:p.bubbles.map(bb=>bb.id===b.id?{...bb,collected:true}:bb)}));setBa(b.duration);break;}
    }
    if(pcd===0&&rs===null){
      for(const pt of ld.portals){
        if(cr(pr,pt.x,pt.y,14)){const tp=ld.portals[pt.pairIndex];if(tp){setPl(p=>({...p,x:tp.x-p.size/2,y:tp.y-p.size/2}));setPcd(50);}break;}
      }
    }

    if(inv>0||ba>0||rs!==null)return;
    let hit=false;
    for(const b of ld.poison){if(rr(pr,b)){hit=true;break;}}
    if(!hit)for(const s of ld.spikes){if(rr(pr,s)){hit=true;break;}}
    if(!hit)for(const e of ld.elevators){
      if(ld.forbiddenColors.includes(e.color)){
        const er={x:e.x+(e.vertical?0:e.offset),y:e.y+(e.vertical?e.offset:0),width:e.width,height:e.height};
        if(rr(pr,er)){hit=true;break;}
      }
    }
    if(!hit)for(const m of ld.monsters){if(cr(pr,m.x,m.y,14)){hit=true;break;}}
    if(!hit)for(const g of ld.gears){if(cr(pr,g.x,g.y,g.radius-4)){hit=true;break;}}
    if(!hit)for(let i=0;i<ld.swings.length;i++){
      if(rs===i)continue;const sw=ld.swings[i];
      const ex=sw.pivotX+Math.sin(sw.angle)*sw.length,ey=sw.pivotY+Math.cos(sw.angle)*sw.length;
      if(cr(pr,ex,ey,11)){hit=true;break;}
    }
    if(hit){setLives(p=>p-1);setInv(90);if(lives<=1)setGs('gameover');}
  },[pl,ld,gs,inv,ba,rs,lvl,lives,startLevel,pcd]);

  // ---- RENDERS ----
  const renderMaze=(maze,cs)=>{
    const w=[];
    for(let y=0;y<maze.length;y++) for(let x=0;x<maze[y].length;x++){
      if(maze[y][x]===1)w.push(el('div',{key:`w${x}-${y}`,style:{position:'absolute',left:x*cs,top:y*cs,width:cs,height:cs,background:'linear-gradient(145deg,#4b5563,#374151 50%,#1f2937)',boxShadow:'inset 1px 1px 3px rgba(255,255,255,.1),inset -1px -1px 3px rgba(0,0,0,.3)',border:'1px solid #1f2937'}}));
    }
    return w;
  };

  const renderSpike=(s)=>{
    let pts;
    if(s.dir==='right')pts=`0,0 ${s.width},${s.height/2} 0,${s.height}`;
    else if(s.dir==='left')pts=`${s.width},0 0,${s.height/2} ${s.width},${s.height}`;
    else if(s.dir==='down')pts=`0,0 ${s.width/2},${s.height} ${s.width},0`;
    else pts=`0,${s.height} ${s.width/2},0 ${s.width},${s.height}`;
    return el('div',{style:{position:'absolute',left:s.x,top:s.y,width:s.width,height:s.height,animation:'spikeGlow 2s infinite'}},
      el('svg',{width:s.width,height:s.height,viewBox:`0 0 ${s.width} ${s.height}`},el('polygon',{points:pts,fill:'#94a3b8',stroke:'#ef4444',strokeWidth:.5}))
    );
  };

  const renderRainbow=(rb)=>{
    const c=['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899'];
    return el('div',{style:{position:'absolute',left:rb.x,top:rb.y,width:rb.width,height:rb.height}},
      c.map((col,i)=>el('div',{key:i,style:{position:'absolute',left:-3+i*1.5,top:0,width:rb.width-i*3,height:rb.height,borderRadius:'50% 50% 0 0',border:`2px solid ${col}`,borderBottom:'none',boxSizing:'border-box',filter:`drop-shadow(0 0 2px ${col})`}})),
      el('div',{style:{position:'absolute',bottom:-10,left:'50%',transform:'translateX(-50%)',fontSize:8,fontWeight:'bold',color:'#fbbf24',textShadow:'0 0 4px #000',whiteSpace:'nowrap'}},'‚òÖ GOAL ‚òÖ')
    );
  };

  const renderGear=(g)=>el('div',{style:{position:'absolute',left:g.x-g.radius,top:g.y-g.radius,width:g.radius*2,height:g.radius*2,transform:`rotate(${g.rotation}rad)`}},
    el('svg',{width:g.radius*2,height:g.radius*2,viewBox:`0 0 ${g.radius*2} ${g.radius*2}`},
      el('circle',{cx:g.radius,cy:g.radius,r:g.radius*.65,fill:'#64748b'}),
      Array.from({length:8}).map((_,i)=>{const a=i/8*Math.PI*2;return el('line',{key:i,x1:g.radius+Math.cos(a)*g.radius*.5,y1:g.radius+Math.sin(a)*g.radius*.5,x2:g.radius+Math.cos(a)*g.radius*.95,y2:g.radius+Math.sin(a)*g.radius*.95,stroke:'#64748b',strokeWidth:g.radius*.25,strokeLinecap:'round'});}),
      el('circle',{cx:g.radius,cy:g.radius,r:g.radius*.2,fill:'#1e293b'})
    )
  );

  const renderSwing=(sw,idx,riding)=>{
    const ex=Math.sin(sw.angle)*sw.length,ey=Math.cos(sw.angle)*sw.length;
    const col=riding?'#22c55e':sw.type==='ball'?'#dc2626':sw.type==='blade'?'#cbd5e1':'#fbbf24';
    const stk=riding?'#16a34a':sw.type==='ball'?'#b91c1c':sw.type==='blade'?'#94a3b8':'#f59e0b';
    const glow=riding?{filter:'drop-shadow(0 0 10px #22c55e)'}:{};
    return el('div',{style:{position:'absolute',left:sw.pivotX,top:sw.pivotY,zIndex:riding?1000:1}},
      el('svg',{width:200,height:200,style:{position:'absolute',left:-100,top:-5,overflow:'visible'}},
        el('line',{x1:0,y1:0,x2:ex,y2:ey,stroke:riding?'#22c55e':'#94a3b8',strokeWidth:2}),
        el('circle',{cx:0,cy:0,r:4,fill:'#475569'}),
        sw.type==='ball'&&el('circle',{cx:ex,cy:ey,r:10,fill:col,stroke:stk,strokeWidth:1.5,style:glow}),
        sw.type==='blade'&&el('polygon',{points:`${ex},${ey-10} ${ex+8},${ey+6} ${ex-8},${ey+6}`,fill:col,stroke:stk,strokeWidth:1.5,style:glow}),
        sw.type==='star'&&el('polygon',{points:Array.from({length:10}).map((_,i)=>{const a=i/10*Math.PI*2-Math.PI/2,r=i%2===0?10:4;return`${ex+Math.cos(a)*r},${ey+Math.sin(a)*r}`;}).join(' '),fill:col,stroke:stk,strokeWidth:1.5,style:glow}),
        !riding&&el('text',{x:ex,y:ey+20,textAnchor:'middle',fontSize:'7',fill:'rgba(255,255,255,.5)'},'[SPACE]')
      )
    );
  };

  const renderElev=(e,forbidden)=>{
    const hex=COLOR_HEX[e.color]||'#fbbf24';const isF=forbidden.includes(e.color);
    return el('div',{style:{position:'absolute',left:e.x+(e.vertical?0:e.offset),top:e.y+(e.vertical?e.offset:0),width:e.width,height:e.height,background:`linear-gradient(to bottom,${hex},${hex}aa)`,borderRadius:3,border:`2px solid ${isF?'#ef4444':'rgba(255,255,255,.3)'}`,boxShadow:isF?`0 0 8px ${hex},0 0 4px #ef4444`:'0 2px 4px rgba(0,0,0,.4)'}},
      isF&&el('div',{style:{position:'absolute',top:-7,left:'50%',transform:'translateX(-50%)',fontSize:6,color:'#fca5a5',fontWeight:'bold'}},'‚ö†Ô∏è')
    );
  };

  // ---- SCREENS ----
  if(gs==='menu'){
    const isBig=lvl>=100;
    return el('div',{style:{width:GW,height:GH,background:'linear-gradient(135deg,#1e1b4b,#312e81 50%,#4c1d95)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'white',position:'relative',borderRadius:12,boxShadow:'0 0 40px rgba(139,92,246,.3)'}},
      el('div',{style:{fontSize:40,fontWeight:'bold',marginBottom:8,background:'linear-gradient(90deg,#ef4444,#f97316,#eab308,#22c55e,#3b82f6,#a855f7,#ec4899)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}},'üåà RAINBOW MAZE üåà'),
      el('div',{style:{fontSize:15,marginBottom:25,opacity:.8,textAlign:'center'}},'Navigate procedural mazes ‚Ä¢ Avoid forbidden colors',el('br'),'Dodge obstacles ‚Ä¢ Reach the rainbow!'),
      el('button',{onClick:()=>setGs('lobby'),style:{padding:'14px 45px',fontSize:22,fontWeight:'bold',background:'linear-gradient(135deg,#22c55e,#16a34a)',border:'none',borderRadius:10,color:'white',cursor:'pointer',boxShadow:'0 4px 15px rgba(34,197,94,.4)'}},'START GAME'),
      el('div',{style:{marginTop:25,fontSize:12,opacity:.7,textAlign:'center',lineHeight:1.9}},
        el('div',null,'üéÆ ARROW KEYS / WASD / Touch controls'),
        el('div',null,'üß± Maze walls ‚Ä¢ üö´ Forbidden colors ‚Ä¢ üìå Wall spikes'),
        el('div',{style:{color:'#22c55e'}},'üéØ SPACE near swings = RIDE through walls!'),
        el('div',null,'üîÆ Portals ‚Ä¢ ü´ß Safety bubbles (Lvl 15+)'),
        el('div',{style:{color:'#f97316'}},'‚ö†Ô∏è Colored platforms can be poisonous!'),
        el('div',{style:{color:'#93c5fd'}},'üèóÔ∏è Mazes get BIGGER at Level 100!'),
        el('div',null,'üåà Reach the rainbow to advance!')
      ),
      el('div',{style:{position:'absolute',bottom:12,fontSize:12,opacity:.5}},'250 Levels ‚Ä¢ All Guaranteed Completable')
    );
  }

  if(gs==='lobby'){
    const totalPages=Math.ceil(TOTAL_LEVELS/LEVELS_PER_PAGE);
    const startIdx=lobbyPage*LEVELS_PER_PAGE;
    const btns=[];
    for(let i=0;i<LEVELS_PER_PAGE;i++){
      const num=startIdx+i+1;if(num>TOTAL_LEVELS)break;
      const isU=num<=unlocked,isC=num===unlocked,isBig=num>=100;
      btns.push(el('button',{key:num,onClick:isU?()=>{setLvl(num);setGs('charSelect');}:null,style:{
        width:55,height:55,borderRadius:10,border:'none',cursor:isU?'pointer':'default',
        display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column',
        fontSize:isU?16:13,fontWeight:'bold',color:'white',position:'relative',
        background:isC?'linear-gradient(135deg,#fbbf24,#f59e0b)':isU?(isBig?'linear-gradient(135deg,#7c3aed,#6d28d9)':'linear-gradient(135deg,#6366f1,#4f46e5)'):'linear-gradient(135deg,#374151,#1f2937)',
        boxShadow:isC?'0 0 15px rgba(251,191,36,.5)':isU?'0 2px 8px rgba(99,102,241,.3)':'none',opacity:isU?1:.5
      }},isU?num:'üîí',isBig&&isU?el('div',{key:'big',style:{position:'absolute',top:2,right:4,fontSize:7,color:'#c4b5fd'}},'BIG'):null));
    }
    return el('div',{style:{width:GW,height:GH,background:'linear-gradient(135deg,#1e1b4b,#312e81)',display:'flex',flexDirection:'column',alignItems:'center',color:'white',borderRadius:12,position:'relative',overflow:'hidden',userSelect:'none'},
      onTouchStart:ev=>{touchRef.current=ev.touches[0].clientX;},
      onTouchEnd:ev=>{if(touchRef.current!==null){const dx=ev.changedTouches[0].clientX-touchRef.current;if(dx<-50&&lobbyPage<totalPages-1)setLobbyPage(p=>p+1);else if(dx>50&&lobbyPage>0)setLobbyPage(p=>p-1);touchRef.current=null;}}
    },
      el('div',{style:{fontSize:28,fontWeight:'bold',marginTop:30,marginBottom:5}},'SELECT LEVEL'),
      el('div',{style:{fontSize:13,opacity:.6,marginBottom:20}},`Unlocked: ${Math.min(unlocked,TOTAL_LEVELS)} / ${TOTAL_LEVELS}`),
      el('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,55px)',gap:10,padding:10,animation:'slideIn .3s ease'}},btns),
      el('div',{style:{display:'flex',alignItems:'center',gap:20,marginTop:25}},
        el('button',{onClick:()=>setLobbyPage(p=>Math.max(0,p-1)),disabled:lobbyPage===0,style:{padding:'8px 16px',fontSize:18,background:lobbyPage===0?'#374151':'#6366f1',border:'none',borderRadius:8,color:'white',cursor:lobbyPage===0?'default':'pointer',opacity:lobbyPage===0?.4:1}},'‚óÄ'),
        el('span',{style:{fontSize:14}},`Page ${lobbyPage+1} / ${totalPages}`),
        el('button',{onClick:()=>setLobbyPage(p=>Math.min(totalPages-1,p+1)),disabled:lobbyPage>=totalPages-1,style:{padding:'8px 16px',fontSize:18,background:lobbyPage>=totalPages-1?'#374151':'#6366f1',border:'none',borderRadius:8,color:'white',cursor:lobbyPage>=totalPages-1?'default':'pointer',opacity:lobbyPage>=totalPages-1?.4:1}},'‚ñ∂')
      ),
      el('div',{style:{fontSize:11,opacity:.5,marginTop:10}},'Swipe or use arrows ‚Ä¢ Levels 100+ have bigger mazes!'),
      el('button',{onClick:()=>setGs('menu'),style:{position:'absolute',top:15,left:15,padding:'6px 14px',fontSize:13,background:'rgba(255,255,255,.1)',border:'1px solid rgba(255,255,255,.2)',borderRadius:8,color:'white',cursor:'pointer'}},'‚Üê Back')
    );
  }

  if(gs==='charSelect'){
    const isBig=lvl>=100;
    return el('div',{style:{width:GW,height:GH,background:'linear-gradient(135deg,#1e1b4b,#312e81)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'white',borderRadius:12}},
      el('div',{style:{fontSize:28,fontWeight:'bold',marginBottom:5}},'CHOOSE YOUR CHARACTER'),
      el('div',{style:{fontSize:13,opacity:.6,marginBottom:5}},`Level ${lvl}`),
      isBig&&el('div',{style:{fontSize:12,color:'#c4b5fd',marginBottom:10,padding:'4px 12px',background:'rgba(124,58,237,.2)',borderRadius:6}},'üèóÔ∏è BIG MAZE ‚Äî Smaller cells, more paths!'),
      el('div',{style:{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:15,padding:'0 40px'}},
        CHARACTERS.map(ch=>el('button',{key:ch.id,onClick:()=>setCharId(ch.id),style:{
          padding:15,borderRadius:12,border:charId===ch.id?'3px solid #fbbf24':'3px solid rgba(255,255,255,.1)',
          background:charId===ch.id?'rgba(251,191,36,.15)':'rgba(255,255,255,.05)',cursor:'pointer',
          display:'flex',flexDirection:'column',alignItems:'center',gap:8,
          boxShadow:charId===ch.id?'0 0 20px rgba(251,191,36,.3)':'none',transition:'all .2s'
        }},
          el('div',{style:{width:60,height:60,display:'flex',alignItems:'center',justifyContent:'center'}},renderCharSVG(ch.id,50)),
          el('div',{style:{fontSize:14,fontWeight:'bold',color:'white'}},ch.name),
          el('div',{style:{fontSize:10,opacity:.6,color:'white'}},ch.desc)
        ))
      ),
      el('div',{style:{display:'flex',gap:15,marginTop:25}},
        el('button',{onClick:()=>setGs('lobby'),style:{padding:'10px 25px',fontSize:16,background:'rgba(255,255,255,.1)',border:'1px solid rgba(255,255,255,.2)',borderRadius:10,color:'white',cursor:'pointer'}},'‚Üê Back'),
        el('button',{onClick:()=>startGame(lvl),style:{padding:'10px 35px',fontSize:18,fontWeight:'bold',background:'linear-gradient(135deg,#22c55e,#16a34a)',border:'none',borderRadius:10,color:'white',cursor:'pointer',boxShadow:'0 4px 15px rgba(34,197,94,.4)'}},'PLAY! ‚Üí')
      )
    );
  }

  if(gs==='intro'&&ld){
    const isBig=lvl>=100;
    return el('div',{style:{width:GW,height:GH,background:'linear-gradient(135deg,#1e1b4b,#312e81)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'white',borderRadius:12}},
      el('div',{style:{marginBottom:12}},renderCharSVG(charId,40)),
      el('div',{style:{fontSize:30,fontWeight:'bold',marginBottom:8}},`Level ${lvl} / ${TOTAL_LEVELS}`),
      isBig&&el('div',{style:{fontSize:12,color:'#c4b5fd',marginBottom:8,padding:'3px 10px',background:'rgba(124,58,237,.2)',borderRadius:6}},'üèóÔ∏è BIG MAZE'),
      el('div',{style:{fontSize:17,marginBottom:12,color:'#fca5a5'}},"‚ö†Ô∏è DON'T TOUCH THESE COLORS ‚ö†Ô∏è"),
      el('div',{style:{display:'flex',gap:10,marginBottom:18,flexWrap:'wrap',justifyContent:'center'}},
        ld.forbiddenColors.map(c=>el('div',{key:c,style:{width:48,height:48,backgroundColor:COLOR_HEX[c],borderRadius:8,display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,fontWeight:'bold',textTransform:'uppercase',boxShadow:`0 0 12px ${COLOR_HEX[c]}`,border:'2px solid rgba(255,255,255,.8)'}},c))
      ),
      el('div',{style:{fontSize:11,opacity:.7,marginBottom:6}},`üëæ${ld.monsters.length} ‚Ä¢ ‚öôÔ∏è${ld.gears.length} ‚Ä¢ üìå${ld.spikes.length} ‚Ä¢ üîÆ${Math.floor(ld.portals.length/2)}`),
      ld.swings.length>0&&el('div',{style:{fontSize:11,color:'#22c55e',marginBottom:4}},`üéØ ${ld.swings.length} rideable swing${ld.swings.length>1?'s':''}!`),
      ld.elevators.some(e=>ld.forbiddenColors.includes(e.color))&&el('div',{style:{fontSize:11,color:'#f97316',marginBottom:4}},'‚ö†Ô∏è Poisonous platforms!'),
      ld.bubbles.length>0&&el('div',{style:{fontSize:11,color:'#93c5fd',marginBottom:4}},`ü´ß ${ld.bubbles.length} bubble${ld.bubbles.length>1?'s':''}`),
      el('div',{style:{fontSize:15,marginTop:6}},`‚ù§Ô∏è Lives: ${lives}`),
      el('div',{style:{marginTop:14,fontSize:15,animation:'pulse 1s infinite'}},isMobile?null:'Press SPACE to begin!'),
      isMobile&&el('button',{onClick:()=>{setKeys({});ltRef.current=0;setGs('playing');},style:{marginTop:10,padding:'12px 35px',fontSize:16,fontWeight:'bold',background:'linear-gradient(135deg,#6366f1,#4f46e5)',border:'none',borderRadius:10,color:'white',cursor:'pointer',boxShadow:'0 4px 12px rgba(99,102,241,.4)',animation:'pulse 1.5s infinite'}},'TAP TO START')
    );
  }

  if(gs==='levelComplete'){
    return el('div',{style:{width:GW,height:GH,background:'linear-gradient(135deg,#064e3b,#047857)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'white',borderRadius:12,animation:'slideIn .3s ease'}},
      el('div',{style:{fontSize:48,marginBottom:10}},'‚ú®'),
      el('div',{style:{fontSize:32,fontWeight:'bold',marginBottom:8,background:'linear-gradient(90deg,#fbbf24,#f97316,#ef4444)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}},`Level ${lvl} Complete!`),
      el('div',{style:{fontSize:16,opacity:.8}},'Loading next level...')
    );
  }

  if(gs==='gameover'){
    return el('div',{style:{width:GW,height:GH,background:'linear-gradient(135deg,#450a0a,#7f1d1d)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'white',borderRadius:12}},
      el('div',{style:{fontSize:42,fontWeight:'bold',marginBottom:18}},'üíÄ GAME OVER'),
      el('div',{style:{fontSize:20,marginBottom:10}},`You reached Level ${lvl}`),
      el('div',{style:{fontSize:15,marginBottom:28,opacity:.8}},lvl>=200?'üèÜ INCREDIBLE!':lvl>=100?'üåü Amazing!':lvl>=50?'‚≠ê Great job!':lvl>=20?'üëç Good effort!':'Keep practicing!'),
      el('div',{style:{display:'flex',gap:12}},
        el('button',{onClick:()=>{setLives(3);startLevel(lvl);},style:{padding:'12px 30px',fontSize:18,fontWeight:'bold',background:'linear-gradient(135deg,#ef4444,#dc2626)',border:'none',borderRadius:10,color:'white',cursor:'pointer'}},'RETRY'),
        el('button',{onClick:()=>{setLobbyPage(Math.floor((lvl-1)/LEVELS_PER_PAGE));setGs('lobby');},style:{padding:'12px 30px',fontSize:18,fontWeight:'bold',background:'rgba(255,255,255,.15)',border:'1px solid rgba(255,255,255,.3)',borderRadius:10,color:'white',cursor:'pointer'}},'LOBBY')
      )
    );
  }

  if(gs==='win'){
    return el('div',{style:{width:GW,height:GH,background:'linear-gradient(135deg,#064e3b,#047857)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'white',borderRadius:12}},
      el('div',{style:{fontSize:42,fontWeight:'bold',marginBottom:18}},'üéâ YOU WIN! üéâ'),
      el('div',{style:{fontSize:20,marginBottom:18}},'All 250 Levels Complete!'),
      el('div',{style:{fontSize:34,fontWeight:'bold',background:'linear-gradient(90deg,#ef4444,#f97316,#eab308,#22c55e,#3b82f6,#a855f7,#ec4899)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}},'üåà RAINBOW MASTER üåà'),
      el('button',{onClick:()=>{setLobbyPage(0);setGs('lobby');},style:{marginTop:28,padding:'14px 40px',fontSize:20,fontWeight:'bold',background:'linear-gradient(135deg,#22c55e,#16a34a)',border:'none',borderRadius:10,color:'white',cursor:'pointer'}},'LOBBY')
    );
  }

  // PLAYING
  if(gs==='playing'&&ld){
    const btr=(ba/60).toFixed(1);const onSw=rs!==null;const cs=ld.cs;
    const gameArea=el('div',{tabIndex:0,style:{width:GW,height:GH,background:'#0c1222',position:'relative',overflow:'hidden',outline:'none',borderRadius:isMobile?'12px 12px 0 0':'12px'}},
      el('div',{style:{position:'absolute',inset:0,backgroundImage:'radial-gradient(circle at 2px 2px,#1e293b 1px,transparent 0)',backgroundSize:`${cs/2}px ${cs/2}px`,opacity:.3}}),
      el('div',{style:{opacity:onSw?.4:1,transition:'opacity .2s'}},renderMaze(ld.maze,cs)),
      ld.spikes.map((s,i)=>el(React.Fragment,{key:`sp${i}`},renderSpike(s))),
      ld.poison.map((b,i)=>el('div',{key:`po${i}`,style:{position:'absolute',left:b.x,top:b.y,width:b.width,height:b.height,backgroundColor:COLOR_HEX[b.color],borderRadius:2,opacity:.9,boxShadow:`0 0 4px ${COLOR_HEX[b.color]},inset 0 0 6px rgba(0,0,0,.3)`}})),
      ld.elevators.map((e,i)=>el(React.Fragment,{key:`el${i}`},renderElev(e,ld.forbiddenColors))),
      ld.portals.map((p,i)=>el('div',{key:`pt${i}`,style:{position:'absolute',left:p.x-12,top:p.y-12,width:24,height:24,borderRadius:'50%',background:`radial-gradient(circle,${p.color} 0%,transparent 70%)`,border:`2px solid ${p.color}`,boxShadow:`0 0 8px ${p.color},0 0 16px ${p.color}`,animation:'portalPulse 1s infinite'}})),
      ld.bubbles.filter(b=>!b.collected).map((b,i)=>el('div',{key:`bu${i}`,style:{position:'absolute',left:b.x-10,top:b.y-10,width:20,height:20,borderRadius:'50%',background:'radial-gradient(circle at 30% 30%,rgba(255,255,255,.9),rgba(147,197,253,.6),rgba(59,130,246,.4))',border:'2px solid rgba(147,197,253,.8)',boxShadow:'0 0 12px rgba(59,130,246,.6)',animation:'bubbleFloat 2s ease-in-out infinite'}})),
      ld.gears.map((g,i)=>el(React.Fragment,{key:`ge${i}`},renderGear(g))),
      ld.swings.map((s,i)=>el(React.Fragment,{key:`sw${i}`},renderSwing(s,i,rs===i))),
      ld.monsters.map((m,i)=>el('div',{key:`mo${i}`,style:{position:'absolute',left:m.x-12,top:m.y-12,width:24,height:24}},
        el('svg',{width:24,height:24,viewBox:'0 0 28 28'},
          el('ellipse',{cx:14,cy:16,rx:11,ry:9,fill:m.color}),
          el('circle',{cx:9,cy:13,r:3,fill:'white'}),el('circle',{cx:19,cy:13,r:3,fill:'white'}),
          el('circle',{cx:9,cy:13,r:1.2,fill:'#1e1e1e'}),el('circle',{cx:19,cy:13,r:1.2,fill:'#1e1e1e'}),
          el('ellipse',{cx:14,cy:20,rx:3.5,ry:2,fill:'#1e1e1e'}),
          el('polygon',{points:'5,5 8,10 2,10',fill:m.color}),el('polygon',{points:'23,5 26,10 20,10',fill:m.color})
        )
      )),
      renderRainbow(ld.rainbow),
      !onSw&&el('div',{style:{
        position:'absolute',left:pl.x,top:pl.y,width:pl.size,height:pl.size,
        opacity:ba>0?.6:inv>0?(Math.floor(inv/4)%2===0?.4:1):1,
        filter:ba>0?'drop-shadow(0 0 10px rgba(147,197,253,.8))':'drop-shadow(0 0 4px rgba(251,191,36,.6))',zIndex:10
      }},
        ba>0&&el('div',{style:{position:'absolute',left:-5,top:-5,width:pl.size+10,height:pl.size+10,borderRadius:'50%',background:'radial-gradient(circle,rgba(147,197,253,.3),transparent 70%)',border:'2px solid rgba(147,197,253,.5)',animation:'bubbleShield .4s ease-in-out infinite alternate'}}),
        renderCharSVG(charId,pl.size)
      ),
      el('div',{style:{position:'absolute',top:0,left:0,right:0,padding:'4px 8px',background:'linear-gradient(to bottom,rgba(0,0,0,.8),transparent)',display:'flex',justifyContent:'space-between',alignItems:'center',color:'white',fontSize:11,fontWeight:'bold',zIndex:100}},
        el('div',{style:{display:'flex',alignItems:'center',gap:6}},
          el('button',{onClick:()=>{setLobbyPage(Math.floor((lvl-1)/LEVELS_PER_PAGE));setGs('lobby');},style:{padding:'2px 6px',fontSize:9,background:'rgba(255,255,255,.15)',border:'1px solid rgba(255,255,255,.2)',borderRadius:4,color:'white',cursor:'pointer'}},'‚ò∞'),
          `Lvl ${lvl}`,
          lvl>=100&&el('span',{style:{fontSize:8,color:'#c4b5fd',marginLeft:2}},'BIG')
        ),
        el('div',{style:{display:'flex',alignItems:'center',gap:4}},
          el('span',{style:{opacity:.8,fontSize:10}},'Avoid:'),
          ld.forbiddenColors.map(c=>el('span',{key:c,style:{width:10,height:10,backgroundColor:COLOR_HEX[c],borderRadius:2,display:'inline-block',border:'1px solid rgba(255,255,255,.5)'}}))
        ),
        el('div',{style:{display:'flex',alignItems:'center',gap:8}},
          onSw&&el('div',{style:{color:'#22c55e',animation:'pulse .5s infinite',fontSize:10}},'üéØ SWING!'),
          ba>0&&!onSw&&el('div',{style:{color:'#93c5fd',animation:'pulse 1s infinite'}},`ü´ß${btr}s`),
          el('div',null,`‚ù§Ô∏è${lives}`)
        )
      )
    );
    if(isMobile) return el('div',{style:{display:'flex',flexDirection:'column',alignItems:'center'}},gameArea,renderTouchControls());
    return gameArea;
  }
  return null;
};

ReactDOM.render(el(Game),document.getElementById('root'));
</script>
</body>
</html>
